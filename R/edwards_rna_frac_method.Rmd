---
title: "Edward's Frac Model"
author: "Sam Haynes"
date: '2022-06-09'
output: html_document
---

```{r setup, include=false}
library(rstan)
library(DESeq2)
library(tidyverse)
library(here)
library(tidybayes)

total_sup_pel_simulated_noisy_counts <- read_tsv(here("data/output/simulated_counts/total_sup_pel_simulated_noisy_skewed_multi_condition_counts.tsv"))
```

```{r mixingratiosTSP_stan}

mdat_mixingTSP <- function(ctdata) {
  ctdata = ctdata %>% arrange(gene_name, rep, condition)
  NRNA=length(unique(ctdata$gene_name))
  NREP=length(unique(ctdata$rep))
  NCON=length(unique(ctdata$condition))
    ## make data for stan fit
    head(ctdata)
    list(NRNA=NRNA,
         NREP=NREP,
         NCON=NCON,
         tot_obs=array(as.integer(round(ctdata$total)), c(NRNA, NREP, NCON)),
         sup_obs=array(as.integer(round(ctdata$sup)), c(NRNA, NREP, NCON)),
         p100_obs=array(as.integer(round(ctdata$pel)), c(NRNA, NREP, NCON))
         )
    
}

make_mixingTSP <- function(ctdata) {
    stan_dat <- mdat_mixingTSP(ctdata)
    stan(model_code='// -*- mode: C -*-
data {
  // Number of RNAs
  int<lower=1> NRNA;
  
  // Number of replicates
  int<lower=1> NREP;
  
  // Number of conditions
  int<lower=1> NCON;
  
  // Note: These are all integers
  // columns t, s, p
  int<lower=0> tot_obs[NRNA, NREP, NCON];
  int<lower=0> sup_obs[NRNA, NREP, NCON];
  int<lower=0> p100_obs[NRNA, NREP, NCON];
}
parameters {
  // Unnormalized mixing proportions
  // real<lower=0> mixing_t[NREP, NCON];
  real<lower=0> mixing_sup[NREP, NCON];
  real<lower=0> mixing_p100[NREP, NCON];
  
  // dispersion parameter for counts
  real phi;
}
model{
  // Cauchy prior for negbin dispersion parameter
  phi ~ cauchy(0,3);
    
  for(con in 1:NCON){
    // mixing ratios
    mixing_sup[, con] ~ gamma(1,1);
    mixing_p100[, con] ~ gamma(1,1);
  
    for(rna in 1:NRNA){ 
      for(rep in 1:NREP){
        // count distn negative binomial with specified means
        // Total
        tot_obs[rna, rep, con] ~ neg_binomial_2(mixing_sup[rep, con] * sup_obs[rna, rep, con] + mixing_p100[rep, con] * p100_obs[rna, rep, con], phi);
      }
    }
  }
}
generated quantities{
  // print("Mixing pars (sup,p100) = (", mixing_sup,",",mixing_p100,")");
  // print("dispersion phi = ", phi);
  // print("------------------");
}
',
data=stan_dat,chains = 1,iter = 10)
}

fit_mixingTSP <- function(ctdata,stan_mixing=NULL,...) {
    stan_dat <- mdat_mixingTSP(ctdata)
    if (is.null(stan_mixing)) {
        stan_mixing <- make_mixingTSP(ctdata)
    }
    stan_mixing_fit <- stan(fit=stan_mixing,data=stan_dat,chains = 4,...)
    return(stan_mixing_fit)
}

getmixingratiosTSP <- function(ctdata,iter=1000,
                                control=list(adapt_delta=0.85),...) {
    # head(ctdata) %>% print()
    stan_model <- fit_mixingTSP(ctdata=ctdata,iter=iter,control=control,...)
    
    # return medians
    list(
      mixing_factors = stan_model %>% 
          spread_draws(mixing_p100[rep, condition],
                       mixing_sup[rep, condition]) %>%
          summarise_draws(),
      phi = stan_model %>% 
          spread_draws(phi) %>%
          summarise_draws(),
      lp = stan_model %>% 
          spread_draws(lp__) %>%
          summarise_draws())
}

```

```{r run-stan-model-on-sim-data}

# compile stan model, test it with 10 iterations, save output
stan_count_model <- total_sup_pel_simulated_noisy_counts %>%
  filter(total > 5,
         sup > 5,
         pel > 5) %>%
    make_mixingTSP()

# Specify a seed for random number generator so output is reproducible
myseed = 39

# run stan mixing ratio inference, reusing same model
mixing_ratios_TSP <- total_sup_pel_simulated_noisy_counts %>%
  filter(total > 5,
         sup > 5,
         pel > 5) %>%
    getmixingratiosTSP(stan_mixing=stan_count_model,iter=1000,seed=myseed)

```

```{r calc-fractions, eval=FALSE}
total_sup_pel_sim_model_frac <- total_sup_pel_simulated_noisy_counts %>%
  mutate(sup = sup * mixing_ratios_TSP$mixing.Sup,
         pel = pel * mixing_ratios_TSP$mixing.P100,
         sup_frac = sup / total,
         pel_frac = pel / total,
         sum = sup + pel)

ggplot(total_sup_pel_sim_model_frac %>%
         mutate(src = "norm") %>%
         dplyr::select(total, sum, src) %>%
         bind_rows(total_sup_pel_simulated_noisy_counts %>%
                     transmute(total,
                               sum = sup + pel,
                               src = "raw"))) +
  geom_point(aes(x = total, y = sum, colour = src)) +
  geom_abline(slope = 1, intercept = 0)

```

```{r run-DESeq2-with-scale-factors}
fractionation_count_matrix_sup <- total_sup_pel_simulated_noisy_counts %>%
  dplyr::select(-total, -pel) %>%
  pivot_wider(names_from = c("rep", "condition"),
              values_from = c("sup")) %>%
  column_to_rownames("gene_name") %>%
  as.matrix()

column_data_sup <- data.frame(fraction = factor(rep("sup",each = 9)),
                          condition = factor(rep(1:3,3)))

rownames(column_data_sup) <- colnames(fractionation_count_matrix_sup)

DESeq2_data_set_sup <- DESeqDataSetFromMatrix(countData = fractionation_count_matrix_sup, 
                                          colData = column_data_sup,
                                          design = ~condition)

sizeFactors(DESeq2_data_set_sup) <- mixing_ratios_TSP$mixing_factors %>% 
  dplyr::select(rep, condition, variable, median) %>% 
  mutate(variable = str_remove(variable, "mixing_"), variable = str_replace(variable, "p100", "pel")) %>% 
  filter(variable == "sup") %>%
  dplyr::select(-variable) %>%
  pivot_wider(names_from = c("rep", "condition"), values_from = "median") %>%
  as_vector()

DESeq2_data_set_sup <- DESeq(DESeq2_data_set_sup)

fractionation_count_matrix_pel <- total_sup_pel_simulated_noisy_counts %>%
  dplyr::select(-total, -sup) %>%
  pivot_wider(names_from = c("rep", "condition"),
              values_from = c("pel")) %>%
  column_to_rownames("gene_name") %>%
  as.matrix()

column_data_pel <- data.frame(fraction = factor(rep("pel",each = 9)),
                          condition = factor(rep(1:3,3)))

rownames(column_data_pel) <- colnames(fractionation_count_matrix_pel)

DESeq2_data_set_pel <- DESeqDataSetFromMatrix(countData = fractionation_count_matrix_pel, 
                                          colData = column_data_pel,
                                          design = ~condition)

sizeFactors(DESeq2_data_set_pel) <- mixing_ratios_TSP$mixing_factors %>% 
  dplyr::select(rep, condition, variable, median) %>% 
  mutate(variable = str_remove(variable, "mixing_"), variable = str_replace(variable, "p100", "pel")) %>% 
  filter(variable == "pel") %>%
  dplyr::select(-variable) %>%
  pivot_wider(names_from = c("rep", "condition"), values_from = "median") %>%
  as_vector()

DESeq2_data_set_pel <- DESeq(DESeq2_data_set_pel)

DESeq2_with_edward_model_results <- results(DESeq2_data_set_sup, c("condition", "3", "1")) %>%
  as.tibble(rownames = "gene_name") %>%
  dplyr::select(gene_name, baseMean, log2FoldChange, pvalue) %>%
  mutate("condition_A" = 3, "condition_B" = 1, fraction = "sup") %>%
  bind_rows(results(DESeq2_data_set_sup, c("condition", "3", "2")) %>%
              as.tibble(rownames = "gene_name") %>%
              dplyr::select(gene_name, baseMean, log2FoldChange, pvalue) %>%
              mutate("condition_A" = 3, "condition_B" = 2, fraction = "sup")) %>%
  bind_rows(results(DESeq2_data_set_sup, c("condition", "2", "1")) %>%
              as.tibble(rownames = "gene_name") %>%
              dplyr::select(gene_name, baseMean, log2FoldChange, pvalue) %>%
              mutate("condition_A" = 2, "condition_B" = 1, fraction = "sup"))%>%
  bind_rows(results(DESeq2_data_set_pel, c("condition", "3", "1")) %>%
              as.tibble(rownames = "gene_name") %>%
              dplyr::select(gene_name, baseMean, log2FoldChange, pvalue) %>%
              mutate("condition_A" = 3, "condition_B" = 1, fraction = "pel")) %>%
  bind_rows(results(DESeq2_data_set_pel, c("condition", "2", "1")) %>%
              as.tibble(rownames = "gene_name") %>%
              dplyr::select(gene_name, baseMean, log2FoldChange, pvalue) %>%
              mutate("condition_A" = 2, "condition_B" = 1, fraction = "pel"))%>%
  bind_rows(results(DESeq2_data_set_pel, c("condition", "3", "2")) %>%
              as.tibble(rownames = "gene_name") %>%
              dplyr::select(gene_name, baseMean, log2FoldChange, pvalue) %>%
              mutate("condition_A" = 3, "condition_B" = 2, fraction = "pel")) 

```

```{r output_results}
write_tsv(DESeq2_with_edward_model_results, here("data/output/diff_frac_models/DESeq2_with_edward_model_results.tsv"))
```