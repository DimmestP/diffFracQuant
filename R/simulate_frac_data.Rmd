---
title: "Simulated Fractionation Dataset"
author: "Sam Haynes"
date: '2022-06-08'
output: pdf_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(MASS)
library(here)

num_gene = 300
num_rep = 3
noisy_neg_bin_dispersion = 20

knitr::opts_chunk$set(echo = FALSE)

thirty_degree_total_rna_count <- read_tsv(here("./data/input/DAD-80.txt"),
                                          col_names = c("gene_name",
                                                        "count")) %>%
  mutate(count = as.integer(count), src = "exp") %>%
  filter(count > 0)

thirty_degree_sup_rna_count <- read_tsv(here("./data/input/DAD-81.txt"),
                                          col_names = c("gene_name",
                                                        "count")) %>%
  mutate(count = as.integer(count), src = "exp") %>%
  filter(count > 0)

thirty_degree_pel_rna_count <- read_tsv(here("./data/input/DAD-82.txt"),
                                          col_names = c("gene_name",
                                                        "count")) %>%
  mutate(count = as.integer(count), src = "exp") %>%
  filter(count > 0)
```

```{r fit-lnorm-rna-count-model}
set.seed(333)
total_count_model <- fitdistr(thirty_degree_total_rna_count$count,"lognormal")

simulate_total_rna_count <- tibble(gene_name = as.character(1:length(thirty_degree_total_rna_count$gene_name)), 
                                   count = rlnorm(length(gene_name),
                                                  meanlog = total_count_model$estimate[1], 
                                                  sdlog = total_count_model$estimate[2]),
                                   src = "sim")

ggplot(thirty_degree_total_rna_count %>%
         bind_rows(simulate_total_rna_count)) +
  geom_histogram(aes(x = log(count),
                   fill = src),
               alpha = 0.7,
               bins = 60,
               position = "identity") +
  theme_light() +
  scale_y_continuous(expand = c(0,0)) +
  labs(x = "ln(RNA count)", y = "", title = "Simulated vs Experimental Total RNA counts")


```

```{r simulated-frac-counts}
set.seed(334)
sample_noisy_counts <- function(mean, dispersion, num_rep, rep_scale_factor){
  noisy_rep_counts <- replicate(num_rep,
            rnbinom(length(mean),
                    size = dispersion,
                    mu  = mean),
            simplify = FALSE) %>%
    unlist()
  
  for(i in 1:num_rep){
    noisy_rep_counts[(1 + length(mean) * (i - 1)) : (length(mean) * i)] <- noisy_rep_counts[(1 + length(mean) * (i - 1)) : (length(mean) * i)] * rep_scale_factor[i]
  }
  
  noisy_rep_counts
}

sup_pel_simulated_fractions <- tibble(sup_frac = c(rep(0.5, num_gene/2),
                                                              rep(0.75,num_gene/4),
                                                              rep(0.25,num_gene/4)),
                                                 pel_frac = 1 - sup_frac)

tot_sup_pel_scale_factor <- tibble(total = runif(num_rep, min = 0.5, max = 3),
                                   sup = runif(num_rep, min = 0.5, max = 3),
                                   pel = runif(num_rep, min = 0.5, max = 3))

total_sup_pel_simulated_mean_counts <- tibble(gene_name = 1:length(sup_pel_simulated_fractions$sup_frac),
                                              total = rlnorm(length(gene_name),
                                                  meanlog = total_count_model$estimate[1], 
                                                  sdlog = total_count_model$estimate[2]),
                                              sup = total * sup_pel_simulated_fractions$sup_frac,
                                              pel = total * sup_pel_simulated_fractions$pel_frac)

total_sup_pel_simulated_noisy_counts <- tibble(gene_name = rep(total_sup_pel_simulated_mean_counts$gene_name, num_rep),
                                               rep = rep(1:num_rep, each = num_gene),
            total = sample_noisy_counts(total_sup_pel_simulated_mean_counts$total,
                                  1,
                                  num_rep,
                                  tot_sup_pel_scale_factor$total),
            sup = sample_noisy_counts(total_sup_pel_simulated_mean_counts$sup,
                                  1,
                                  num_rep,
                                  tot_sup_pel_scale_factor$sup),
            pel = sample_noisy_counts(total_sup_pel_simulated_mean_counts$pel,
                                  1,
                                  num_rep,
                                  tot_sup_pel_scale_factor$pel)) %>%
  mutate(total = as.integer(total),
         sup = as.integer(sup),
         pel = as.integer(pel)) %>%
  arrange(gene_name)
```

```{r noisy_sim_vs_real_counts}
noisy_sim_and_real_counts <- thirty_degree_total_rna_count %>%
  mutate(frac = "total") %>%
  sample_n(num_gene) %>%
  bind_rows(thirty_degree_sup_rna_count %>%
               mutate(frac = "sup") %>%
              sample_n(num_gene)) %>%
  bind_rows(thirty_degree_pel_rna_count %>%
               mutate(frac = "pel") %>%
              sample_n(num_gene)) %>%
  bind_rows(total_sup_pel_simulated_noisy_counts %>%
                     filter(rep == 1) %>%
                     transmute(gene_name = as.character(gene_name),
                               count = total,
                               src = "sim",
                               frac = "total")) %>%
  bind_rows(total_sup_pel_simulated_noisy_counts %>%
                     filter(rep == 1) %>%
                     transmute(gene_name = as.character(gene_name),
                               count = sup,
                               src = "sim",
                               frac = "sup")) %>%
  bind_rows(total_sup_pel_simulated_noisy_counts %>%
                     filter(rep == 1) %>%
                     transmute(gene_name = as.character(gene_name),
                               count = pel,
                               src = "sim",
                               frac = "pel"))

ggplot(noisy_sim_and_real_counts) +
  geom_histogram(aes(x = log(count),
                   fill = src),
               alpha = 0.7,
               bins = 60,
               position = "identity") +
  theme_light() +
  scale_y_continuous(expand = c(0,0)) +
  labs(x = "ln(RNA count)", y = "", title = "Simulated vs Experimental RNA counts") +
  facet_grid(frac~1)

```

```{r output-sim-counts}
write_tsv(total_sup_pel_simulated_noisy_counts, here("data/output/simulated_counts/total_sup_pel_simulated_noisy_counts.tsv"))
```
