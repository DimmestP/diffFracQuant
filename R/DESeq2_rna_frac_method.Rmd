---
title: "DESeq2 RNA frac method"
author: "Sam Haynes"
date: '2022-06-14'
output: pdf_document
---

```{r setup, include=FALSE}
library(here)
library(DESeq2)
library(tidyverse)

total_sup_pel_iserman_et_al_counts <- read_tsv(here("data/input/Iserman_et_al_dataset/full_transcript_counts.txt"))
```

```{r run-DESeq}
fractionation_count_matrix_IDR_30C_IDR_40C <- total_sup_pel_iserman_et_al_counts %>%
  select("ensembl_gene_id", "IDR_30C_1_pellet_262", "IDR_30C_2_pellet_263",
         "IDR_30C_1_SN_244","IDR_30C_2_SN_245", "IDR_40C_1_pellet_264",
        "IDR_40C_2_pellet_265", "IDR_40C_1_SN_246", "IDR_40C_2_SN_247") %>%
  column_to_rownames("ensembl_gene_id") %>%
  as.matrix()

column_data_IDR_30C_IDR_40C <- data.frame(fraction = factor(rep(rep(c("pel", "sup"), each = 2), 2)),
                          condition = factor(rep(c("IDR.30C", "IDR.40C"), each = 4)))

rownames(column_data_IDR_30C_IDR_40C) <- colnames(fractionation_count_matrix_IDR_30C_IDR_40C)

DESeq2_data_set_IDR_30C_IDR_40C <- DESeqDataSetFromMatrix(countData = fractionation_count_matrix_IDR_30C_IDR_40C, 
                                          colData = column_data_IDR_30C_IDR_40C,
                                          design = ~fraction * condition)

DESeq2_data_set_IDR_30C_IDR_40C <- DESeq(DESeq2_data_set_IDR_30C_IDR_40C, test = "LRT", reduced = ~fraction + condition)


DESeq2_result_IDR_30C_IDR_40C <- results(DESeq2_data_set_IDR_30C_IDR_40C)

fractionation_count_matrix_WT_30C_WT_40C <- total_sup_pel_iserman_et_al_counts %>%
  select("ensembl_gene_id", "WT_30C_1_pellet_250", "WT_30C_2_pellet_251",
         "WT_30C_1_SN_232","WT_30C_2_SN_233", "WT_40C_1_pellet_252",
        "WT_40C_2_pellet_253", "WT_40C_1_SN_234", "WT_40C_2_SN_235") %>%
  column_to_rownames("ensembl_gene_id") %>%
  as.matrix()

column_data_WT_30C_WT_40C <- data.frame(fraction = factor(rep(rep(c("pel", "sup"), each = 2), 2)),
                          condition = factor(rep(c("WT.30C", "WT.40C"), each = 4)))

rownames(column_data_WT_30C_WT_40C) <- colnames(fractionation_count_matrix_WT_30C_WT_40C)

DESeq2_data_set_WT_30C_WT_40C <- DESeqDataSetFromMatrix(countData = fractionation_count_matrix_WT_30C_WT_40C, 
                                          colData = column_data_WT_30C_WT_40C,
                                          design = ~fraction * condition)

DESeq2_data_set_WT_30C_WT_40C <- DESeq(DESeq2_data_set_WT_30C_WT_40C, test = "LRT", reduced = ~fraction + condition)


DESeq2_result_WT_30C_WT_40C <- results(DESeq2_data_set_WT_30C_WT_40C)


DESeq2_model_results <- results(DESeq2_data_set_WT_30C_WT_40C, name = "fractionsup.conditionWT.40C") %>%
              as.tibble(rownames = "gene_name") %>%
              dplyr::select(gene_name, baseMean, log2FoldChange, pvalue) %>%
              mutate("condition_AB" = "WT_40C_WT_30C") %>%
  bind_rows(results(DESeq2_data_set_IDR_30C_IDR_40C, name = "fractionsup.conditionIDR.40C") %>%
              as.tibble(rownames = "gene_name") %>%
              dplyr::select(gene_name, baseMean, log2FoldChange, pvalue) %>%
              mutate("condition_AB" = "IDR_40C_IDR_30C"))

ggplot(DESeq2_model_results %>% 
         filter(baseMean > 50) %>%
         select(gene_name, log2FoldChange, condition_AB) %>% 
         pivot_wider(names_from = "condition_AB", values_from = "log2FoldChange") %>%
         inner_join(DESeq2_model_results %>% 
                      transmute(gene_name, significant = pvalue < 0.05, 
                                condition_AB = paste0(condition_AB, "_sig")) %>% 
                      pivot_wider(names_from = condition_AB, values_from = significant))) +
  geom_point(aes(x=WT_40C_WT_30C, y=IDR_40C_IDR_30C, colour = (WT_40C_WT_30C_sig & !IDR_40C_IDR_30C_sig)), alpha = 0.4) +
  theme_bw() +
  coord_equal() +
  geom_abline(slope = 1, intercept = 0) +
  labs(colour = "")
```

```{r save-result, eval=FALSE}
write_tsv(DESeq2_model_results, here("./data/output/diff_frac_models/DESeq2_only_multi_condition_results.tsv"))
```
