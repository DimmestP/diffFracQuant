---
title: "frac_model_comparison"
author: "Sam Haynes"
date: '2022-06-14'
output: pdf_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(here)

latent_model_results <- read_tsv(here("data/output/diff_frac_models/latent_model_count.tsv"))


DESeq_model_results <- read_tsv(here("data/output/diff_frac_models/DESeq2_only_counts.tsv"))

latent_model_results_skewed <- read_tsv(here("data/output/diff_frac_models/latent_model_skewed_count.tsv"))

latent_model_results_skewed_multi_condition <-  read_tsv(here("data/output/diff_frac_models/latent_model_skewed_multi_condition_count.tsv"))

simulate_skewed_multi_condition_fractions <-  read_tsv(here("data/output/simulated_counts/sup_pel_simulated_fractions.tsv")) 

DESeq_model_results_skewed <- read_tsv(here("data/output/diff_frac_models/DESeq2_only_skewed_counts.tsv"))

DESeq2_with_raw_model_results <- read_tsv(here("data/output/diff_frac_models/DESeq2_with_edward_model_results.tsv"))

DESeq2_model_multi_condition_results <- read_tsv(here("./data/output/diff_frac_models/DESeq2_only_multi_condition_results.tsv"))
```

```{r function}
calc_FPR_and_TPR <- function(p.value, foldchange, truth, threshold){
  
  TN_equal = sum(p.value[truth == "equal"] > threshold, na.rm = TRUE)
  FP_equal = sum(truth == "equal" & !is.na(p.value)) - TN_equal
  
  TP_sup = sum(p.value[truth == "sup" & !is.na(foldchange) & foldchange > 0] <= threshold, na.rm = TRUE)
  FN_sup = sum(truth == "sup"& !is.na(p.value)) - TP_sup
  
  TP_pel = sum(p.value[truth == "pel" & !is.na(foldchange) & foldchange < 0] <= threshold, na.rm = TRUE)
  FN_pel = sum(truth == "pel"& !is.na(p.value)) - TP_pel
  
  tibble(threshold, true_positive = (TP_pel + TP_sup) / sum(truth != "equal"),
         false_positive = FP_equal / sum(truth == "equal"))
}

calc_FPR_and_TPR_latent <- function(p.value, truth, threshold){
  pred_equal <- truth[p.value > threshold & p.value < (1 - threshold)]
  
  TN <- sum(pred_equal == "equal")
  
  pred_sup <- truth[p.value < (threshold)]
  
  pred_pel <- truth[p.value > (1 - threshold)]
  
  TP = sum(pred_sup == "sup") + sum(pred_pel == "pel")
  
  TN_equal = sum(equal_gene_p.value > (threshold / 2) & equal_gene_p.value < (1 - (threshold / 2)), na.rm = TRUE)
  FP_equal = sum(truth == "equal" & !is.na(p.value)) - TN_equal
  
  TP_sup = sum(sup_gene_p.value >= (1 - threshold), na.rm = TRUE)
  FN_sup = sum(truth == "sup"& !is.na(p.value)) - TP_sup
  
  TP_pel = sum(pel_gene_p.value <= threshold, na.rm = TRUE)
  FN_pel = sum(truth == "pel"& !is.na(p.value)) - TP_pel
  
  tibble(threshold, true_positive = (TP_pel + TP_sup) / sum(truth != "equal"),
         false_positive = FP_equal / sum(truth == "equal"))
}

calc_ROC_values <- function(p.value, foldchange, truth, latent = FALSE){
  if(latent){
    tibble(threshold = seq(0,1,0.05)) %>%
      group_by(threshold) %>%
      summarise(calc_FPR_and_TPR_latent(p.value, truth, threshold))
  }
  else{
    tibble(threshold = seq(0,1,0.05)) %>%
      group_by(threshold) %>%
      summarise(calc_FPR_and_TPR(p.value, foldchange, truth, threshold))}
}
  
```

```{r compare-models-single-condition}
detect_diff_exp_DESeq <- DESeq_model_results %>%
  dplyr::select(gene_name, log2FoldChange, pvalue) %>%
  filter(pvalue < 0.05)

detect_diff_exp_latent <- latent_model_results %>%
  dplyr::select(gene_name, ratio, p.value) %>%
  filter(p.value < 0.025 | p.value > 0.975) %>%
  transmute(gene_name, log2FoldChange = log2(ratio), pvalue = p.value)

detect_diff_exp_DESeq_skewed <- DESeq_model_results_skewed %>%
  dplyr::select(gene_name, log2FoldChange, pvalue) %>%
  filter(pvalue < 0.05)

detect_diff_exp_latent_skewed <- latent_model_results_skewed %>%
  dplyr::select(gene_name, ratio, p.value) %>%
  filter(p.value < 0.025 | p.value > 0.975) %>%
  transmute(gene_name, log2FoldChange = log2(ratio), pvalue = p.value)

summary <- tibble(TP_DESeq = sum(((detect_diff_exp_DESeq$gene_name > 150 &
                                     detect_diff_exp_DESeq$gene_name <= 225 &
                                     detect_diff_exp_DESeq$log2FoldChange > 0)) |
                                   (detect_diff_exp_DESeq$gene_name > 225 &
                                      detect_diff_exp_DESeq$log2FoldChange < 0)),
                  FP_DESeq = length(detect_diff_exp_DESeq$gene_name) - TP_DESeq,
                  TP_latent = sum((detect_diff_exp_latent$gene_name > 150 &
                                     detect_diff_exp_latent$gene_name <= 225) |
                                   (detect_diff_exp_latent$gene_name > 225)),
                  FP_latent = length(detect_diff_exp_latent$gene_name) - TP_latent,
                  TP_DESeq_skewed = sum(((detect_diff_exp_DESeq_skewed$gene_name <= 280 &
                                     detect_diff_exp_DESeq_skewed$log2FoldChange > 0)) |
                                   (detect_diff_exp_DESeq_skewed$gene_name > 280 &
                                      detect_diff_exp_DESeq_skewed$log2FoldChange < 0)),
                  FP_DESeq_skewed = length(detect_diff_exp_DESeq_skewed$gene_name) - TP_DESeq_skewed,
                  TP_latent_skewed = sum((detect_diff_exp_latent_skewed$gene_name <= 280) |
                                   (detect_diff_exp_latent_skewed$gene_name > 280)),
                  FP_latent_skewed = length(detect_diff_exp_latent_skewed$gene_name) - TP_latent_skewed)
                  

summary
```

```{r compare-models-multi-condition}
# calc ground truth
expand_conditions <- tibble(condition_A = unique(simulate_skewed_multi_condition_fractions$condition)) %>%
  expand(condition_A, condition_B=condition_A) %>%
  filter(condition_B < condition_A)

simulated_groundtruth <- expand_conditions %>%
  inner_join(
    simulate_skewed_multi_condition_fractions %>%
      pivot_longer(c("sup_frac", "pel_frac"), names_to = "fraction", values_to = "proportion_A") %>%
      dplyr::rename(condition_A = condition)) %>%
  inner_join(
    simulate_skewed_multi_condition_fractions %>%
      pivot_longer(c("sup_frac", "pel_frac"), names_to = "fraction", values_to = "proportion_B") %>%
      dplyr::rename(condition_B = condition)) %>%
  transmute(gene_name,
            condition_A,
            condition_B,
            fraction = str_remove(fraction, "_frac"),
            true_ratio  = proportion_A/proportion_B,
            diff_condition_A = (true_ratio) > 1,
            diff_condition_B = (true_ratio) < 1)

# calc DESeq2 decisions
DESeq2_model_pred_with_ground_truth_multi_condition <- DESeq2_model_multi_condition_results %>%
  mutate(condition_A_frac = (pvalue < 0.1) & (log2FoldChange > 0),
         condition_B_frac = (pvalue < 0.1) & (log2FoldChange < 0)) %>%
  select(-baseMean, log2FoldChange) %>%
  inner_join(simulated_groundtruth)

# calc raw scale factors with DESeq2 decisions
raw_model_pred_with_ground_truth_multi_condition <- DESeq2_with_raw_model_results %>%
  mutate(condition_A_frac = (pvalue < 0.1) & (log2FoldChange > 0),
         condition_B_frac = (pvalue < 0.1) & (log2FoldChange < 0)) %>%
  select(-baseMean, log2FoldChange) %>%
  inner_join(simulated_groundtruth)

# calc latent model decisions

latent_model_pred_with_ground_truth_multi_condition <-  latent_model_results_skewed_multi_condition %>%
  mutate(condition_A_frac = p.value > 0.975,
         condition_B_frac = p.value < 0.025) %>%
  mutate(fraction = str_remove(variable, "_latent")) %>%
  dplyr::select(-variable) %>%
  inner_join(simulated_groundtruth)

# summary

multi_condition_model_comparison <- tibble(
  latent_FP_con_A = latent_model_pred_with_ground_truth_multi_condition %>%
    filter(condition_A_frac & !diff_condition_A) %>%
    pull(gene_name) %>%
    length(),
  latent_TP_con_A = latent_model_pred_with_ground_truth_multi_condition %>%
    filter(condition_A_frac & diff_condition_A) %>%
    pull(gene_name) %>%
    length(),
  latent_FP_con_B = latent_model_pred_with_ground_truth_multi_condition %>%
    filter(condition_B_frac & !diff_condition_B) %>%
    pull(gene_name) %>%
    length(),
  latent_TP_con_B = latent_model_pred_with_ground_truth_multi_condition %>%
    filter(condition_B_frac & diff_condition_B) %>%
    pull(gene_name) %>%
    length(),
  raw_FP_con_A = raw_model_pred_with_ground_truth_multi_condition %>%
    filter(condition_A_frac & !diff_condition_A) %>%
    pull(gene_name) %>%
    length(),
  raw_TP_con_A = raw_model_pred_with_ground_truth_multi_condition %>%
    filter(condition_A_frac & diff_condition_A) %>%
    pull(gene_name) %>%
    length(),
  raw_FP_con_B = raw_model_pred_with_ground_truth_multi_condition %>%
    filter(condition_B_frac & !diff_condition_B) %>%
    pull(gene_name) %>%
    length(),
  raw_TP_con_B = raw_model_pred_with_ground_truth_multi_condition %>%
    filter(condition_B_frac & diff_condition_B) %>%
    pull(gene_name) %>%
    length(),
  DESeq_FP_con_A = DESeq2_model_pred_with_ground_truth_multi_condition %>%
    filter(condition_A_frac & !diff_condition_A) %>%
    pull(gene_name) %>%
    length(),
  DESeq_TP_con_A = DESeq2_model_pred_with_ground_truth_multi_condition %>%
    filter(condition_A_frac & diff_condition_A) %>%
    pull(gene_name) %>%
    length(),
  DESeq_FP_con_B = DESeq2_model_pred_with_ground_truth_multi_condition %>%
    filter(condition_B_frac & !diff_condition_B) %>%
    pull(gene_name) %>%
    length(),
  DESeq_TP_con_B = DESeq2_model_pred_with_ground_truth_multi_condition %>%
    filter(condition_B_frac & diff_condition_B) %>%
    pull(gene_name) %>%
    length()
)






```

```{r plot-results}
multi_condition_plot_data <- latent_model_pred_with_ground_truth_multi_condition %>%
  transmute(gene_name, 
            condition_AB = str_c("Con ", condition_A, " vs Con ", condition_B),
            fraction,
            true_ratio,
            log2FoldChange = log2(median_A / median_B),
            method = "Latent",
            Significant = condition_A_frac | condition_B_frac) %>%
  bind_rows(raw_model_pred_with_ground_truth_multi_condition %>%
              transmute(gene_name,
                        condition_AB = str_c("Con ", condition_A, " vs Con ", condition_B),
                        fraction,
                        true_ratio,
                        log2FoldChange,
                        method = "Original",
                        Significant = condition_A_frac | condition_B_frac)) %>%
  bind_rows(DESeq2_model_pred_with_ground_truth_multi_condition %>%
              transmute(gene_name,
                        condition_AB = str_c("Con ", condition_A, " vs Con ", condition_B),
                        fraction,
                        true_ratio,
                        log2FoldChange,
                        method = "DESeq",
                        Significant = condition_A_frac | condition_B_frac)) %>%
  filter(!is.na(Significant))

ggplot(multi_condition_plot_data %>%
         filter(fraction == "pel")) +
  geom_point(aes(x = log2(true_ratio), y = log2FoldChange, colour = Significant), alpha = 0.3) +
  geom_abline(slope = 1, intercept = 0, colour = "black", alpha = 0.7) +
  facet_grid(condition_AB~method) +
  coord_equal() +
  theme_bw()
```