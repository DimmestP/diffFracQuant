---
title: "frac_model_comparison"
author: "Sam Haynes"
date: '2022-06-14'
output: pdf_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(here)

latent_model_results <- read_tsv(here("data/output/diff_frac_models/latent_model_count.tsv"))


DESeq_model_results <- read_tsv(here("data/output/diff_frac_models/DESeq2_only_counts.tsv"))

latent_model_results_skewed <- read_tsv(here("data/output/diff_frac_models/latent_model_skewed_count.tsv"))

latent_model_results_skewed_multi_condition <-  read_tsv(here("data/output/diff_frac_models/latent_model_skewed_multi_condition_count.tsv"))

simulate_skewed_multi_condition_fractions <-  read_tsv(here("data/output/simulated_counts/sup_pel_simulated_fractions.tsv")) 

DESeq_model_results_skewed <- read_tsv(here("data/output/diff_frac_models/DESeq2_only_skewed_counts.tsv"))
```

```{r function}
calc_FPR_and_TPR <- function(p.value, foldchange, truth, threshold){
  
  TN_equal = sum(p.value[truth == "equal"] > threshold, na.rm = TRUE)
  FP_equal = sum(truth == "equal" & !is.na(p.value)) - TN_equal
  
  TP_sup = sum(p.value[truth == "sup" & !is.na(foldchange) & foldchange > 0] <= threshold, na.rm = TRUE)
  FN_sup = sum(truth == "sup"& !is.na(p.value)) - TP_sup
  
  TP_pel = sum(p.value[truth == "pel" & !is.na(foldchange) & foldchange < 0] <= threshold, na.rm = TRUE)
  FN_pel = sum(truth == "pel"& !is.na(p.value)) - TP_pel
  
  tibble(threshold, true_positive = (TP_pel + TP_sup) / sum(truth != "equal"),
         false_positive = FP_equal / sum(truth == "equal"))
}

calc_FPR_and_TPR_latent <- function(p.value, truth, threshold){
  pred_equal <- truth[p.value > threshold & p.value < (1 - threshold)]
  
  TN <- sum(pred_equal == "equal")
  
  pred_sup <- truth[p.value < (threshold)]
  
  pred_pel <- truth[p.value > (1 - threshold)]
  
  TP = sum(pred_sup == "sup") + sum(pred_pel == "pel")
  
  TN_equal = sum(equal_gene_p.value > (threshold / 2) & equal_gene_p.value < (1 - (threshold / 2)), na.rm = TRUE)
  FP_equal = sum(truth == "equal" & !is.na(p.value)) - TN_equal
  
  TP_sup = sum(sup_gene_p.value >= (1 - threshold), na.rm = TRUE)
  FN_sup = sum(truth == "sup"& !is.na(p.value)) - TP_sup
  
  TP_pel = sum(pel_gene_p.value <= threshold, na.rm = TRUE)
  FN_pel = sum(truth == "pel"& !is.na(p.value)) - TP_pel
  
  tibble(threshold, true_positive = (TP_pel + TP_sup) / sum(truth != "equal"),
         false_positive = FP_equal / sum(truth == "equal"))
}

calc_ROC_values <- function(p.value, foldchange, truth, latent = FALSE){
  if(latent){
    tibble(threshold = seq(0,1,0.05)) %>%
      group_by(threshold) %>%
      summarise(calc_FPR_and_TPR_latent(p.value, truth, threshold))
  }
  else{
    tibble(threshold = seq(0,1,0.05)) %>%
      group_by(threshold) %>%
      summarise(calc_FPR_and_TPR(p.value, foldchange, truth, threshold))}
}
  
```

```{r compare-models-single-condition}
detect_diff_exp_DESeq <- DESeq_model_results %>%
  dplyr::select(gene_name, log2FoldChange, pvalue) %>%
  filter(pvalue < 0.05)

detect_diff_exp_latent <- latent_model_results %>%
  dplyr::select(gene_name, ratio, p.value) %>%
  filter(p.value < 0.025 | p.value > 0.975) %>%
  transmute(gene_name, log2FoldChange = log2(ratio), pvalue = p.value)

detect_diff_exp_DESeq_skewed <- DESeq_model_results_skewed %>%
  dplyr::select(gene_name, log2FoldChange, pvalue) %>%
  filter(pvalue < 0.05)

detect_diff_exp_latent_skewed <- latent_model_results_skewed %>%
  dplyr::select(gene_name, ratio, p.value) %>%
  filter(p.value < 0.025 | p.value > 0.975) %>%
  transmute(gene_name, log2FoldChange = log2(ratio), pvalue = p.value)

summary <- tibble(TP_DESeq = sum(((detect_diff_exp_DESeq$gene_name > 150 &
                                     detect_diff_exp_DESeq$gene_name <= 225 &
                                     detect_diff_exp_DESeq$log2FoldChange > 0)) |
                                   (detect_diff_exp_DESeq$gene_name > 225 &
                                      detect_diff_exp_DESeq$log2FoldChange < 0)),
                  FP_DESeq = length(detect_diff_exp_DESeq$gene_name) - TP_DESeq,
                  TP_latent = sum((detect_diff_exp_latent$gene_name > 150 &
                                     detect_diff_exp_latent$gene_name <= 225) |
                                   (detect_diff_exp_latent$gene_name > 225)),
                  FP_latent = length(detect_diff_exp_latent$gene_name) - TP_latent,
                  TP_DESeq_skewed = sum(((detect_diff_exp_DESeq_skewed$gene_name <= 280 &
                                     detect_diff_exp_DESeq_skewed$log2FoldChange > 0)) |
                                   (detect_diff_exp_DESeq_skewed$gene_name > 280 &
                                      detect_diff_exp_DESeq_skewed$log2FoldChange < 0)),
                  FP_DESeq_skewed = length(detect_diff_exp_DESeq_skewed$gene_name) - TP_DESeq_skewed,
                  TP_latent_skewed = sum((detect_diff_exp_latent_skewed$gene_name <= 280) |
                                   (detect_diff_exp_latent_skewed$gene_name > 280)),
                  FP_latent_skewed = length(detect_diff_exp_latent_skewed$gene_name) - TP_latent_skewed)
                  

View(summary)
```

```{r compare-models-multi-condition}
 simulated_groundtruth <- simulate_skewed_multi_condition_fractions %>%
  transmute(gene_name,
            condition,
            true_sup_frac = sup_frac > 0.55,
            true_pel_frac = pel_frac > 0.55)

model_pred_with_ground_truth_multi_condtion <-  latent_model_results_skewed_multi_condition %>%
  mutate(pel_frac = p.value > 0.975,
         sup_frac = p.value < 0.025) %>%
  inner_join(simulated_groundtruth)

FP_pel <- model_pred_with_ground_truth_multi_condtion %>%
  filter(pel_frac & !true_pel_frac) %>%
  pull(gene_name) %>%
  length()

TP_pel <- model_pred_with_ground_truth_multi_condtion %>%
  filter(pel_frac & true_pel_frac) %>%
  pull(gene_name) %>%
  length()

FP_sup <- model_pred_with_ground_truth_multi_condtion %>%
  filter(sup_frac & !true_sup_frac) %>%
  pull(gene_name) %>%
  length()

TP_sup <- model_pred_with_ground_truth_multi_condtion %>%
  filter(sup_frac & true_sup_frac) %>%
  pull(gene_name) %>%
  length()
```