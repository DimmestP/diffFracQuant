---
title: "Guido's model"
author: "Sam Haynes"
date: '2022-06-09'
output: html_document
---

```{r setup, include=FALSE}
library(rstan)
library(tidyverse)
library(here)
library(tidybayes)

options(mc.cores = parallel::detectCores())

total_sup_pel_simulated_noisy_counts <- read_tsv(here("data/output/simulated_counts/total_sup_pel_simulated_noisy_counts.tsv"))
```

```{r mixingratiosTSP_stan}
mdat_mixingTSP <- function(ctdata) {
  # fix order of counts so grouped together by replicate
  ctdata = ctdata %>%
    arrange(rep)
  
  # define total rep and RNA
  NRNA=length(unique(ctdata$gene_name))
  NREP=length(unique(ctdata$rep))
  
    ## make data for stan fit
    list(NRNA=NRNA,
         NREP=NREP,
         tot_obs=array(as.integer(round(ctdata$total)), c(NRNA,NREP)),
         sup_obs=array(as.integer(round(ctdata$sup)), c(NRNA,NREP)),
         pel_obs=array(as.integer(round(ctdata$pel)), c(NRNA,NREP))
         )
    
}

make_mixingTSP <- function(ctdata) {
    stan_dat <- mdat_mixingTSP(ctdata)
    stan(model_code='// -*- mode: C -*-
data {
  // Number of RNAs
  int<lower=1> NRNA; 
  
  // Number of replicates
  int<lower=1> NREP; 
  
  // Note: These are all integers
  // columns t, s, p
  int<lower=0> tot_obs[NRNA, NREP];
  int<lower=0> sup_obs[NRNA, NREP];
  int<lower=0> pel_obs[NRNA, NREP];
}
parameters {
  // Normalising factors
  
  // latent counts
  real<lower=0> sup_latent[NRNA];
  real<lower=0> pel_latent[NRNA];
  
  // latent count gamma prior parameters
  real<lower=0> sup_gamma_beta;
  real<lower=0> pel_gamma_beta;
  
  // dispersion parameter for counts
  real<lower=0> tot_phi;
}
model{
  for(rna in 1:NRNA){
    for(rep in 1:NREP){ 
      // fractions
      sup_obs[rna,rep] ~ lognormal( sup_latent[rna], sup_gamma_beta);
      pel_obs[rna,rep] ~ lognormal( pel_latent[rna], pel_gamma_beta);
  
      // count distn negative binomial with specified means
      // total
      tot_obs[rna,rep] ~ lognormal(sup_latent[rna] + pel_latent[rna], tot_phi);
    }
  }
}
generated quantities{
  // print("Mixing pars (sup,p100) = (", mixing_sup,",",mixing_p100,")");
  // print("dispersion phi = ", phi);
  // print("------------------");
}
',
data=stan_dat,chains = 1,iter = 10)
}

fit_mixingTSP <- function(ctdata,stan_mixing=NULL,...) {
    stan_dat <- mdat_mixingTSP(ctdata)
    if (is.null(stan_mixing)) {
        stan_mixing <- make_mixingTSP(ctdata)
    }
    stan_mixing_fit <- stan(fit=stan_mixing,data=stan_dat,chains = 4,...)
    return(stan_mixing_fit)
}

getmixingratiosTSP <- function(ctdata,iter=1000,
                                control=list(adapt_delta=0.85),...) {
    # head(ctdata) %>% print()
    stan_model <- fit_mixingTSP(ctdata=ctdata,iter=iter,control=control,...)
    
    # return medians
    list(
        norm_factors=stan_model %>% 
          spread_draws(tot_norm_factor[rep],
                       sup_norm_factor[rep]) %>%
          summarise_draws(),
        latent_counts = stan_model %>% 
          spread_draws(sup_latent[gene_name],
                       pel_latent[gene_name]) %>%
          summarise_draws(),
        dispersion_parameters = stan_model %>% 
          spread_draws(sup_gamma_alpha,
                       sup_gamma_beta,
                       pel_gamma_alpha,
                       pel_gamma_beta,
                       tot_phi) %>%
          summarise_draws(),
        lp = stan_model %>% 
          spread_draws(lp__) %>%
          summarise_draws())
}

```

```{r run-stan-model-on-sim-data, eval=FALSE}

# compile stan model, test it with 10 iterations, save output
stan_count_model <- total_sup_pel_simulated_noisy_counts %>%
  filter(total > 5,
         sup > 5,
         pel > 5) %>%
    make_mixingTSP()

# Specify a seed for random number generator so output is reproducible
myseed = 39

# run stan mixing ratio inference, reusing same model
mixing_ratios_TSP <- total_sup_pel_simulated_noisy_counts %>%
    getmixingratiosTSP(, stan_mixing=stan_count_model,iter=500,seed=myseed)

stan_count_model <- total_sup_pel_simulated_noisy_counts %>%
  filter(total > 5,
         sup > 5,
         pel > 5) %>%
    make_mixingTSP()

mixing_ratios_TSP <- total_sup_pel_simulated_noisy_counts %>%
    getmixingratiosTSP(, stan_mixing=stan_count_model,iter=50,seed=myseed)

stan_count_model <- total_sup_pel_simulated_noisy_counts %>%
  filter(total > 5,
         sup > 5,
         pel > 5) %>%
    fit_mixingTSP(, stan_mixing=stan_count_model,iter=2000)

launch_shinystan(stan_count_model)

```

```{r output_results, eval=FALSE}
write_tsv(mixing_ratios_TSP, here("data/output/stan_model/mixing_ratios_TSP_latent.tsv"))
```
