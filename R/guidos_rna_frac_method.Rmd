---
title: "Guido's model"
author: "Sam Haynes"
date: '2022-06-09'
output: html_document
---

```{r setup, include=FALSE}
library(rstan)
library(tidyverse)
library(here)

options(mc.cores = parallel::detectCores())

total_sup_pel_simulated_noisy_counts <- read_tsv(here("data/output/simulated_counts/total_sup_pel_simulated_noisy_counts.tsv"))
```

```{r mixingratiosTSP_stan}
mdat_mixingTSP <- function(ctdata) {
    ## make data for stan fit
    head(ctdata)
    list(NRNA=nrow(ctdata),
         tot_obs=as.integer(round(ctdata$total)),
         sup_obs=as.integer(round(ctdata$sup)),
         pel_obs=as.integer(round(ctdata$pel))
         )
    
}

make_mixingTSP <- function(ctdata) {
    stan_dat <- mdat_mixingTSP(ctdata)
    stan(model_code='// -*- mode: C -*-
data {
  // Number of RNAs
  int<lower=1> NRNA;     
  
  // Note: These are all integers
  // columns t, s, p
  int<lower=0> tot_obs[NRNA];
  int<lower=0> sup_obs[NRNA];
  int<lower=0> pel_obs[NRNA];
}
parameters {
  // Normalising factors
  real<lower=0> tot_norm_factor;
  real<lower=0> sup_norm_factor;
  real<lower=0> pel_norm_factor;
  
  // latent counts
  real<lower=0> sup_latent[NRNA];
  real<lower=0> pel_latent[NRNA];
  
  // latent count gamma prior parameters
  real<lower=0> sup_gamma_alpha;
  real<lower=0> sup_gamma_beta;
  real<lower=0> pel_gamma_alpha;
  real<lower=0> pel_gamma_beta;
  
  // dispersion parameter for counts
  real tot_phi;
}
model{
  // normalising factors
  tot_norm_factor ~ gamma(1,1);
  sup_norm_factor ~ gamma(1,1);
  pel_norm_factor ~ gamma(1,1);
  
  // latent counts
  sup_gamma_alpha ~ normal(7,2);
  pel_gamma_alpha ~ normal(7,2);
  
  sup_gamma_beta ~ gamma(1,1);
  pel_gamma_beta ~ gamma(1,1);
  
  sup_latent ~ gamma(sup_gamma_alpha, sup_gamma_beta);
  pel_latent ~ gamma(pel_gamma_alpha, pel_gamma_beta);
  
  // Cauchy prior for negbin dispersion parameter
  tot_phi ~ cauchy(0,3);
  
  for(idx in 1:NRNA){ 
    // fractions
    sup_obs[idx] ~ poisson(sup_norm_factor * sup_latent[idx]);
    pel_obs[idx] ~ poisson(pel_norm_factor * pel_latent[idx]);
  
    // count distn negative binomial with specified means
    // total
    tot_obs[idx] ~ neg_binomial_2(tot_norm_factor * (sup_latent[idx] + pel_latent[idx]), tot_phi);
  }

}
generated quantities{
  // print("Mixing pars (sup,p100) = (", mixing_sup,",",mixing_p100,")");
  // print("dispersion phi = ", phi);
  // print("------------------");
}
',
data=stan_dat,chains = 1,iter = 10)
}

fit_mixingTSP <- function(ctdata,stan_mixing=NULL,...) {
    stan_dat <- mdat_mixingTSP(ctdata)
    if (is.null(stan_mixing)) {
        stan_mixing <- make_mixingTSP(ctdata)
    }
    stan_mixing_fit <- stan(fit=stan_mixing,data=stan_dat,chains = 4,...)
    return(stan_mixing_fit)
}

getmixingratiosTSP <- function(ctdata,iter=1000,
                                control=list(adapt_delta=0.85),...) {
    # head(ctdata) %>% print()
    stansummary <- fit_mixingTSP(ctdata=ctdata,iter=iter,control=control,...) %>%
        summary()
    stansummary
    # return medians
    #list(
      #  tot_norm_factor=stansummary$summary["tot_norm_factor","50%"],
     #   sup_norm_factor=stansummary$summary["sup_norm_factor","50%"],
       # pel_norm_factor=stansummary$summary["pel_norm_factor","50%"],
      #  sup_gamma_alpha=stansummary$summary["sup_gamma_alpha","50%"],
    #    sup_gamma_beta=stansummary$summary["sup_gamma_beta","50%"],
     #   pel_gamma_alpha=stansummary$summary["pel_gamma_alpha","50%"],
      #  pel_gamma_beta=stansummary$summary["pel_gamma_beta","50%"],
#        pel_latent=stansummary$summary["pel_latent","50%"],
 #       sup_latent=stansummary$summary["sup_latent","50%"],
  #      lp.n_eff  =stansummary$summary["lp__","n_eff"],
   #     lp.Rhat   =stansummary$summary["lp__","Rhat"])
}

```

```{r run-stan-model-on-sim-data}

# compile stan model, test it with 10 iterations, save output
stan_count_model <- total_sup_pel_simulated_noisy_counts %>%
  filter(total > 5,
         sup > 5,
         pel > 5) %>%
    make_mixingTSP()

# Specify a seed for random number generator so output is reproducible
myseed = 39

# run stan mixing ratio inference, reusing same model
mixing_ratios_TSP <- total_sup_pel_simulated_noisy_counts %>%
  filter(total > 5,
         sup > 5,
         pel > 5) %>%
    getmixingratiosTSP(, stan_mixing=stan_count_model,iter=500,seed=myseed)

```

```{r output_results}
write_tsv(mixing_ratios_TSP, here("data/output/stan_model/mixing_ratios_TSP_latent.tsv"))
```
